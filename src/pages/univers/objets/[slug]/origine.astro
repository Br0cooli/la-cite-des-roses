---
import ObjectLayout from "@layouts/ObjectLayout.astro";

interface MetaObjet {
  name: string;
  subtitle?: string;
  typeLabel?: string;
  owner?: string;
  origin?: string;
  rarity?: string;
  image?: string;
}

interface OrigineData {
  creationContext?: string;
  materials?: string;
  craftingTechnique?: string;
  initialOwner?: string;
  historyOfUse?: string[];
  manufacturingAnecdotes?: string[];
}

interface Props {
  slug: string;
  origine: OrigineData | null;
  meta: MetaObjet | null;
}

const { slug, origine, meta } = Astro.props as Props;

export async function getStaticPaths() {
  // origine.json
  const origineModules = import.meta.glob("@data/objets/*/origine.json");

  // meta.json
  const metaModules = import.meta.glob("@data/objets/*/meta.json", {
    eager: true
  });

  // map slug -> meta
  const metaMap: Record<string, MetaObjet> = {};
  for (const [path, mod] of Object.entries(metaModules)) {
    const json = (mod as any).default ?? mod;
    const match = path.match(/objets\/([^/]+)\/meta\.json$/);
    const slug = match ? match[1] : "";
    if (slug) metaMap[slug] = json;
  }

  const entries = await Promise.all(
    Object.entries(origineModules).map(async ([path, resolver]) => {
      const mod: any = await resolver();
      const json = (mod?.default ?? mod) as OrigineData;

      const match = path.match(/objets\/([^/]+)\/origine\.json$/);
      const slug = match ? match[1] : "";

      return {
        params: { slug },
        props: {
          slug,
          origine: json,
          meta: metaMap[slug] ?? null
        }
      };
    })
  );

  return entries;
}

const basePath = `/univers/objets/${slug}`;
---

<ObjectLayout
  name={meta?.name ?? "Objet"}
  subtitle={meta?.subtitle}
  typeLabel={meta?.typeLabel}
  owner={meta?.owner}
  origin={meta?.origin}
  rarity={meta?.rarity}
  image={meta?.image}
  basePath={basePath}
  currentSection="origine"
>
  <section class="object-section">
    <h2 class="section-title">Origine & fabrication</h2>

    {origine?.creationContext && (
      <p class="object-summary">{origine.creationContext}</p>
    )}

    {!origine && (
      <p class="object-empty">
        Aucun fichier <code>origine.json</code> trouvé.<br />
        Chemin attendu : <code>src/data/objets/{slug}/origine.json</code>.
      </p>
    )}

    {origine && (
      <div class="object-origin-grid">
        {origine.materials && (
          <article class="object-origin-block">
            <h3>Matériaux</h3>
            <p>{origine.materials}</p>
          </article>
        )}

        {origine.craftingTechnique && (
          <article class="object-origin-block">
            <h3>Technique de fabrication</h3>
            <p>{origine.craftingTechnique}</p>
          </article>
        )}

        {origine.initialOwner && (
          <article class="object-origin-block">
            <h3>Premier propriétaire</h3>
            <p>{origine.initialOwner}</p>
          </article>
        )}

        {origine.historyOfUse && origine.historyOfUse.length > 0 && (
          <article class="object-origin-block">
            <h3>Histoire de l’usage</h3>
            <ul>
              {origine.historyOfUse.map((item) => (
                <li>{item}</li>
              ))}
            </ul>
          </article>
        )}

        {origine.manufacturingAnecdotes &&
          origine.manufacturingAnecdotes.length > 0 && (
            <article class="object-origin-block">
              <h3>Anecdotes de fabrication</h3>
              <ul>
                {origine.manufacturingAnecdotes.map((a) => (
                  <li>{a}</li>
                ))}
              </ul>
            </article>
          )}
      </div>
    )}
  </section>
</ObjectLayout>
