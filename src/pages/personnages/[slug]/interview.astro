---
import CharacterLayout from "../../../layouts/CharacterLayout.astro";

interface MetaPersonnage {
  name: string;
  title?: string;
  role?: string;
  tag?: string;
  arc?: string;
  avatar?: string;
  [key: string]: any;
}

interface InterviewQuestion {
  id: string;
  text: string;
  answer?: string;
}

interface InterviewSection {
  id: string;
  title: string;
  questions: InterviewQuestion[];
}

interface InterviewData {
  sections?: InterviewSection[];
}

interface Props {
  meta: MetaPersonnage;
  slug: string;
  interview: InterviewData | null;
}

const { meta, slug, interview } = Astro.props as Props;
const basePath = `/personnages/${slug}`;

// Génère /personnages/<slug>/interview
export async function getStaticPaths() {
  const metaModules = import.meta.glob("../../../data/personnages/*/meta.json");
  const interviewModules = import.meta.glob(
    "../../../data/personnages/*/interview.json"
  );

  const interviewMap: Record<string, InterviewData> = {};

  await Promise.all(
    Object.entries(interviewModules).map(async ([path, resolver]) => {
      const mod: any = await resolver();
      const data = mod.default as InterviewData;

      const match = path.match(/personnages\/([^/]+)\/interview\.json$/);
      const s = match ? match[1] : "";
      if (s) interviewMap[s] = data;
    })
  );

  const entries = await Promise.all(
    Object.entries(metaModules).map(async ([path, resolver]) => {
      const mod: any = await resolver();
      const data = mod.default as MetaPersonnage;

      const match = path.match(/personnages\/([^/]+)\/meta\.json$/);
      const s = match ? match[1] : "";

      return {
        params: { slug: s },
        props: {
          meta: data,
          slug: s,
          interview: interviewMap[s] || null
        }
      };
    })
  );

  return entries;
}

const sections = interview?.sections ?? [];
---

<CharacterLayout
  name={meta.name}
  subtitle={meta.title || meta.role}
  tag={meta.tag}
  arc={meta.arc}
  basePath={basePath}
  currentSection="interview"
>
  <section class="card">
    <h3 class="page-title" style="margin-left:0;">Interview</h3>
    <p class="page-subtitle" style="margin-left:0;">
      Questions pour explorer la personnalité de {meta.name} en profondeur.
    </p>

    {sections.length === 0 ? (
      <p style="margin-top:1rem;font-size:0.9rem;color:var(--text-muted);">
        Aucune interview n’est encore définie pour ce personnage.
        Ajoute un fichier <code>interview.json</code> dans son dossier pour
        configurer les questions et les réponses.
      </p>
    ) : (
      <div class="interview-layout">
        {sections.map((section) => (
          <section class="interview-section">
            <h4 class="interview-section-title">{section.title}</h4>

            <ul class="interview-questions-list">
              {section.questions.map((q) => (
                <li class="interview-question-item">
                  <p class="interview-question-text">{q.text}</p>

                  {q.answer && q.answer.trim().length > 0 && (
                    <p class="interview-answer">{q.answer}</p>
                  )}
                </li>
              ))}
            </ul>
          </section>
        ))}
      </div>
    )}
  </section>
</CharacterLayout>