---
import CharacterLayout from "../../../layouts/CharacterLayout.astro";

interface MetaPersonnage {
  name: string;
  title?: string;
  role?: string;
  tag?: string;
  arc?: string;
  avatar?: string;
  [key: string]: any;
}

interface InterviewData {
  answers?: Record<string, string>;
}

interface Props {
  meta: MetaPersonnage;
  slug: string;
  interview: InterviewData | null;
}

const { meta, slug, interview } = Astro.props as Props;
const basePath = `/personnages/${slug}`;

// üî•üî•üî• OBLIGATOIRE üî•üî•üî•
// G√©n√®re une page /personnages/<slug>/interview pour chaque perso
export async function getStaticPaths() {
  // on charge tous les meta.json
  const metaModules = import.meta.glob("../../../data/personnages/*/meta.json");
  // on charge tous les interview.json
  const interviewModules = import.meta.glob(
    "../../../data/personnages/*/interview.json"
  );

  const interviewMap: Record<string, InterviewData> = {};

  // map interview -> slug
  await Promise.all(
    Object.entries(interviewModules).map(async ([path, resolver]) => {
      const mod: any = await resolver();
      const data = mod.default as InterviewData;

      const match = path.match(/personnages\/([^/]+)\/interview\.json$/);
      const s = match ? match[1] : "";
      if (s) interviewMap[s] = data;
    })
  );

  // on g√©n√®re toutes les pages
  const entries = await Promise.all(
    Object.entries(metaModules).map(async ([path, resolver]) => {
      const mod: any = await resolver();
      const data = mod.default as MetaPersonnage;

      const match = path.match(/personnages\/([^/]+)\/meta\.json$/);
      const s = match ? match[1] : "";

      return {
        params: { slug: s },
        props: {
          meta: data,
          slug: s,
          interview: interviewMap[s] || null
        }
      };
    })
  );

  return entries;
}

// =============================================================
// QUESTIONS ‚Äî sections + questions (fixes, customis√©es renaissance fantasy)
// =============================================================
const sections = [
  {
    id: "intro",
    title: "Pr√©sentation & identit√©",
    questions: [
      { id: "intro-present", text: "Si tu devais te pr√©senter sans ton titre, comment te d√©crirais-tu ?" },
      { id: "intro-three-words", text: "Trois mots qui te r√©sument ?" },
      { id: "intro-seen-by-others", text: "Comment crois-tu que les autres te per√ßoivent r√©ellement ?" },
      { id: "intro-secret", text: "Quelle v√©rit√© sur toi ne doit surtout pas s‚Äô√©bruiter ?" }
    ]
  },
  {
    id: "gouts",
    title: "Go√ªts & habitudes",
    questions: [
      { id: "gouts-food", text: "Quel est ton plat pr√©f√©r√© dans tout le royaume ?" },
      { id: "gouts-color", text: "Quelle couleur te ressemble le plus, et pourquoi ?" },
      { id: "gouts-rain", text: "Que fais-tu quand la pluie bloque toute sortie ?" },
      { id: "gouts-hobby", text: "Quelle est ton activit√© favorite lorsque personne ne te surveille ?" },
      { id: "gouts-season", text: "Quelle saison te met le plus √† l‚Äôaise, et laquelle te rend m√©lancolique ?" }
    ]
  },
  {
    id: "relations",
    title: "Relations, loyaut√©s & tensions",
    questions: [
      { id: "rel-trust", text: "√Ä qui ferais-tu confiance pour garder un secret compromettant ?" },
      { id: "rel-envy", text: "Y a-t-il quelqu‚Äôun que tu envies en silence ?" },
      { id: "rel-love", text: "Qu‚Äôest-ce qui t‚Äôattire profond√©ment chez quelqu‚Äôun ?" },
      { id: "rel-betrayal", text: "Qu‚Äôest-ce qui constituerait pour toi une trahison impardonnable ?" },
      { id: "rel-rumor", text: "Quelle rumeur circule √† ton sujet et t‚Äôagace le plus ?" }
    ]
  },
  {
    id: "past",
    title: "Pass√© & blessures",
    questions: [
      { id: "past-good", text: "Ton souvenir d‚Äôenfance le plus doux ?" },
      { id: "past-dark", text: "Celui que tu voudrais effacer de ta m√©moire ?" },
      { id: "past-turning", text: "Quel √©v√©nement a marqu√© un tournant dans ta vie ?" },
      { id: "past-regret", text: "Ton plus grand regret ?" }
    ]
  },
  {
    id: "role",
    title: "Destin, devoirs & ambitions",
    questions: [
      { id: "role-duty", text: "Te sens-tu √† ta place dans le r√¥le que tu occupes ?" },
      { id: "role-ambition", text: "Qu'aimerais-tu devenir si tout t‚Äô√©tait permis ?" },
      { id: "role-fear", text: "Qu‚Äôest-ce qui t‚Äôeffraie le plus dans le pouvoir des autres ?" },
      { id: "role-mask", text: "En quoi diff√®res-tu en public par rapport √† ta vraie nature ?" }
    ]
  },
  {
    id: "intime",
    title: "Vuln√©rabilit√©s & v√©rit√© int√©rieure",
    questions: [
      { id: "int-fear", text: "De quoi as-tu r√©ellement peur, derri√®re les apparences ?" },
      { id: "int-selfcomfort", text: "Qu‚Äôest-ce qui t‚Äôapaise imm√©diatement ?" },
      { id: "int-boundary", text: "Quelle limite ne doit jamais √™tre franchie avec toi ?" },
      { id: "int-secret-habit", text: "As-tu une habitude secr√®te que tu caches ?" }
    ]
  },
  {
    id: "hypo",
    title: "Sc√©narios & tests de caract√®re",
    questions: [
      { id: "hypo-save", text: "Si tu ne pouvais sauver qu‚Äôune seule personne, comment choisirais-tu ?" },
      { id: "hypo-exile", text: "Si tu devais partir en exil demain, que prendrais-tu dans un seul coffre ?" },
      { id: "hypo-truth", text: "Pr√©f√©rerais-tu conna√Ætre toute la v√©rit√©, ou garder certains mensonges utiles ?" },
      { id: "hypo-deal", text: "Accepterais-tu un pacte dangereux pour obtenir ton v≈ìu le plus cher ?" }
    ]
  }
];

const answers = interview?.answers ?? {};
---

<CharacterLayout
  name={meta.name}
  subtitle={meta.title || meta.role}
  tag={meta.tag}
  arc={meta.arc}
  basePath={basePath}
  currentSection="interview"
>
  <section class="card">
    <h3 class="page-title" style="margin-left:0;">Interview</h3>
    <p class="page-subtitle" style="margin-left:0;">
      Questions pour explorer la personnalit√© de {meta.name} en profondeur.
    </p>

    <div class="interview-layout">
      {sections.map((section) => (
        <section class="interview-section">
          <h4 class="interview-section-title">{section.title}</h4>

          <ul class="interview-questions-list">
            {section.questions.map((q) => (
              <li class="interview-question-item">
                <p class="interview-question-text">{q.text}</p>

                {answers[q.id] && (
                  <p class="interview-answer">{answers[q.id]}</p>
                )}
              </li>
            ))}
          </ul>
        </section>
      ))}
    </div>
  </section>
</CharacterLayout>
