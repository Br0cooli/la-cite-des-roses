---
import BaseLayout from "../layouts/BaseLayout.astro";

const module = await import("../data/chronologie/evenements.json");
const events: any[] = module.default;

// Plots définis : 3 colonnes fixes
const plots = [
  { id: "principal", label: "Plot principal" },
  { id: "delia_leandre", label: "Delia & Léandre" },
  { id: "delia_alois", label: "Delia & Aloïs" }
];

// Années uniques, triées
const years = Array.from(new Set(events.map((e) => e.annee))).sort(
  (a, b) => a - b
);
---

<BaseLayout title="Chronologie — La Cité des Roses">
  <section class="card">
    <h1 class="page-title">Chronologie</h1>

    <div class="chronology-grid">
      <div class="chronology-header">
        <div class="chronology-year-col">Temps</div>
        {plots.map((plot) => (
          <div class="chronology-arc-col">
            {plot.label}
          </div>
        ))}
      </div>

      <div class="chronology-body">
        {years.map((year) => (
          <div class="chronology-row">
            <div class="chronology-year-col">
              <span class="chronology-year-pill">Année {year}</span>
            </div>

            {plots.map((plot) => {
              const evts = events.filter(
                (e) => e.annee === year && e.plot === plot.id
              );

              const hasEvent = evts.length > 0;

              return (
                <div class="chronology-cell">
                  <div
                    class={
                      "chronology-timeline-rail" +
                      (hasEvent ? " has-event" : "")
                    }
                  >
                    {hasEvent && <span class="chronology-timeline-dot"></span>}
                  </div>

                  <div class="chronology-events">
                    {evts.map((evt) => (
                      <article
                        class="chronology-event"
                        data-title={evt.titre}
                        data-description={evt.detail || evt.description}
                        data-year={evt.annee}
                        data-plot={plot.label}
                      >
                        <h3>{evt.titre}</h3>
                        <p>{evt.description}</p>
                      </article>
                    ))}

                  </div>
                </div>
              );
            })}
          </div>
        ))}
      </div>
    </div>
        <div
      class="chronology-lightbox"
      id="chronology-lightbox"
      aria-hidden="true"
    >
      <div
        class="chronology-lightbox-backdrop"
        data-chronology-close
      ></div>

      <div class="chronology-lightbox-content" role="dialog" aria-modal="true">
        <button
          class="chronology-lightbox-close"
          type="button"
          data-chronology-close
          aria-label="Fermer"
        >
          ×
        </button>

        <div class="chronology-lightbox-body">
          <p
            class="chronology-lightbox-meta"
            id="chronology-lightbox-meta"
          ></p>
          <h2
            class="chronology-lightbox-title"
            id="chronology-lightbox-title"
          ></h2>
          <p
            class="chronology-lightbox-desc"
            id="chronology-lightbox-desc"
          ></p>
        </div>
      </div>
    </div>
  </section>
      <script>
      if (typeof window !== "undefined") {
        const lightbox = document.getElementById("chronology-lightbox");
        const metaEl = document.getElementById("chronology-lightbox-meta");
        const titleEl = document.getElementById("chronology-lightbox-title");
        const descEl = document.getElementById("chronology-lightbox-desc");

        function openChronologyLightbox(card) {
          if (!lightbox || !card) return;

          const title = card.dataset.title || "";
          const description = card.dataset.description || "";
          const year = card.dataset.year || "";
          const plot = card.dataset.plot || "";

          if (metaEl) {
            if (year && plot) {
              metaEl.textContent = `Année ${year} · ${plot}`;
            } else if (year) {
              metaEl.textContent = `Année ${year}`;
            } else {
              metaEl.textContent = plot;
            }
          }

          if (titleEl) titleEl.textContent = title;
          if (descEl) descEl.textContent = description;

          lightbox.classList.add("is-open");
          document.body.classList.add("chronology-modal-open");
        }

        function closeChronologyLightbox() {
          if (!lightbox) return;
          lightbox.classList.remove("is-open");
          document.body.classList.remove("chronology-modal-open");
        }

        // ouverture au clic sur une carte
        document.addEventListener("click", (event) => {
          const target = event.target;
          if (!(target instanceof HTMLElement)) return;

          const card = target.closest(".chronology-event");
          if (card) {
            openChronologyLightbox(card);
          }
        });

        // boutons et backdrop de fermeture
        if (lightbox) {
          const closers = lightbox.querySelectorAll("[data-chronology-close]");
          closers.forEach((el) => {
            el.addEventListener("click", () => {
              closeChronologyLightbox();
            });
          });
        }

        // Esc pour fermer
        document.addEventListener("keydown", (event) => {
          if (event.key === "Escape") {
            closeChronologyLightbox();
          }
        });
      }
    </script>
</BaseLayout>
