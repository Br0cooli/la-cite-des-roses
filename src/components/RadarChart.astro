---
interface Axis {
  label: string;
  value: number;
}

interface Props {
  axes: Axis[];
  maxValue?: number;
}

const { axes, maxValue = 10 } = Astro.props as Props;

const count = axes.length;

// on se cale sur un carré 400x400
const cx = 200;
const cy = 200;
const radius = 140; // rayon principal

function clamp(val: number, min: number, max: number) {
  return Math.max(min, Math.min(max, val));
}

function getPoint(index: number, value: number) {
  const ratio = clamp(value, 0, maxValue) / maxValue;
  const r = radius * ratio;
  const angle = (Math.PI * 2 * index) / count - Math.PI / 2;
  const x = cx + r * Math.cos(angle);
  const y = cy + r * Math.sin(angle);
  return { x, y };
}

const polygonPoints = axes
  .map((axis, i) => {
    const { x, y } = getPoint(i, axis.value);
    return `${x},${y}`;
  })
  .join(" ");

const rings = [0.25, 0.5, 0.75, 1];

// viewBox serré autour du radar + labels
const viewBox = `0 0 400 400`;
---

<div class="radar-wrapper">
  <svg
    class="radar-svg"
    viewBox={viewBox}
    role="img"
    aria-label="Statistiques générales du personnage"
  >
    {/* fond circulaire */}
    <circle
      cx={cx}
      cy={cy}
      r={radius + 10}
      fill="#FFF8EE"
      stroke="rgba(216,190,143,0.6)"
      stroke-width="1"
    />

    {/* anneaux */}
    {rings.map((r) => (
      <circle
        cx={cx}
        cy={cy}
        r={radius * r}
        fill="none"
        stroke="rgba(216,190,143,0.45)"
        stroke-width="0.8"
        stroke-dasharray="2 3"
      />
    ))}

    {/* axes */}
    {axes.map((axis, i) => {
      const angle = (Math.PI * 2 * i) / count - Math.PI / 2;
      const x = cx + radius * Math.cos(angle);
      const y = cy + radius * Math.sin(angle);
      return (
        <line
          x1={cx}
          y1={cy}
          x2={x}
          y2={y}
          stroke="rgba(216,190,143,0.65)"
          stroke-width="1"
        />
      );
    })}

    {/* polygone des valeurs */}
    <polygon
      points={polygonPoints}
      fill="rgba(216,190,143,0.35)"
      stroke="rgba(200,165,106,0.9)"
      stroke-width="1.4"
    />

    {/* points aux extrémités */}
    {axes.map((axis, i) => {
      const { x, y } = getPoint(i, axis.value);
      return (
        <circle
          cx={x}
          cy={y}
          r="3"
          fill="#FFF8EE"
          stroke="rgba(200,165,106,0.95)"
          stroke-width="1.2"
        />
      );
    })}

    {/* LABELS AU BOUT DES BRANCHES */}
    {axes.map((axis, i) => {
      const angle = (Math.PI * 2 * i) / count - Math.PI / 2;
      const labelRadius = radius + 28; // distance du texte
      const x = cx + labelRadius * Math.cos(angle);
      const y = cy + labelRadius * Math.sin(angle);

      let textAnchor: "start" | "middle" | "end" = "middle";
      if (Math.cos(angle) > 0.3) textAnchor = "start";
      else if (Math.cos(angle) < -0.3) textAnchor = "end";

      const dy =
        Math.sin(angle) > 0.3 ? "0.9em" : Math.sin(angle) < -0.3 ? "-0.3em" : "0.3em";

      return (
        <text
          x={x}
          y={y}
          text-anchor={textAnchor}
          dy={dy}
          class="radar-axis-label"
        >
          {axis.label}
        </text>
      );
    })}
  </svg>
</div>
